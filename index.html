<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å ±åç¾æ³å„€è¡¨æ¿ | Hello World 2025</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js åœ–è¡¨åº« -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen p-6 bg-gradient-to-br from-gray-100 to-gray-200">

    <!-- Header -->
    <div class="max-w-7xl mx-auto mb-8 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">ğŸ“Š å ±åç¾æ³å„€è¡¨æ¿</h1>
            <p class="text-gray-500 mt-1">Hello World 2025 é–‹ç™¼è€…å¤§æœƒå¿ƒå¾—åˆ†äº«</p>
        </div>
        <button onclick="fetchData()" class="bg-teal-500 hover:bg-teal-600 text-white px-4 py-2 rounded-lg shadow flex items-center gap-2 transition">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
            é‡æ–°æ•´ç†
        </button>
    </div>

    <!-- Loading State -->
    <div id="loading" class="flex flex-col items-center justify-center h-64">
        <div class="loader mb-4"></div>
        <p class="text-gray-500">æ­£åœ¨å¾ Google Sheets è®€å–è³‡æ–™...</p>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboard" class="hidden max-w-7xl mx-auto space-y-6">
        
        <!-- é—œéµæŒ‡æ¨™ (KPI Cards) -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- ç¸½å ±åäººæ•¸ -->
            <div class="card border-l-4 border-blue-500">
                <h3 class="text-gray-500 text-sm font-medium">ç¸½å ±åäººæ•¸</h3>
                <p class="text-4xl font-bold text-gray-800 mt-2" id="totalCount">0</p>
                <p class="text-xs text-gray-400 mt-1">å³æ™‚æ›´æ–°</p>
            </div>
            <!-- éœ€è¦èŒ¶é» -->
            <div class="card border-l-4 border-yellow-500">
                <h3 class="text-gray-500 text-sm font-medium">èŒ¶é»éœ€æ±‚äººæ•¸</h3>
                <p class="text-4xl font-bold text-gray-800 mt-2" id="snackCount">0</p>
                <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                    <div id="snackProgress" class="bg-yellow-500 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>
            <!-- åƒèˆ‡å–®ä½æ•¸ -->
            <div class="card border-l-4 border-green-500">
                <h3 class="text-gray-500 text-sm font-medium">åƒèˆ‡å–®ä½æ•¸</h3>
                <p class="text-4xl font-bold text-gray-800 mt-2" id="unitCount">0</p>
                <p class="text-xs text-gray-400 mt-1">ä¾†è‡ªä¸åŒéƒ¨é–€çš„å¤¥ä¼´</p>
            </div>
        </div>

        <!-- åœ–è¡¨å€åŸŸ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- è·ç¨±åˆ†ä½ˆ (åœ“é¤…åœ–) -->
            <div class="card">
                <h3 class="text-lg font-bold text-gray-700 mb-4">ğŸ‘¥ è·ç¨±åˆ†ä½ˆ</h3>
                <div class="relative h-64">
                    <canvas id="titleChart"></canvas>
                </div>
            </div>
            
            <!-- å–®ä½å ±åç‹€æ³ (é•·æ¢åœ–) -->
            <div class="card">
                <h3 class="text-lg font-bold text-gray-700 mb-4">ğŸ¢ å„å–®ä½å ±åç‹€æ³ (Top 5)</h3>
                <div class="relative h-64">
                    <canvas id="unitChart"></canvas>
                </div>
            </div>
        </div>

        <!-- æœ€æ–°å ±ååˆ—è¡¨ -->
        <div class="card overflow-hidden">
            <h3 class="text-lg font-bold text-gray-700 mb-4">ğŸ“‹ æœ€æ–° 5 ç­†å ±åè³‡æ–™</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ™‚é–“</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å§“å</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å–®ä½</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è·ç¨±</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">èŒ¶é»</th>
                        </tr>
                    </thead>
                    <tbody id="recentTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Javascript å°‡åœ¨æ­¤æ’å…¥è³‡æ–™ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ğŸš¨ GAS Web App ç¶²å€å·²æ›´æ–°ç‚ºæ‚¨æä¾›çš„è·¯å¾‘ ğŸš¨
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwsVBci7v4jfAQS-efgwiWulH5H54evKQk_ER8mizEd7iqNwAYyVHE_ie7WuhcjeWVYBA/exec';

        // Chart å¯¦ä¾‹ (ç”¨æ–¼æ›´æ–°/éŠ·æ¯€)
        let titleChartInstance = null;
        let unitChartInstance = null;

        // åˆå§‹åŒ–
        fetchData();

        /**
         * å¸¶æœ‰æŒ‡æ•¸é€€é¿çš„ fetch å‡½æ•¸ (å¢åŠ é€£ç·šç©©å®šæ€§)
         */
        async function fetchWithRetry(url, options = {}, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        // å¦‚æœæ˜¯ 429 (Too Many Requests) æˆ–å…¶ä»–ä¼ºæœå™¨éŒ¯èª¤ï¼Œå‰‡é‡è©¦
                        if (response.status === 429 || response.status >= 500) {
                            throw new Error(`Server error: ${response.statusText}`);
                        }
                    }
                    return response; // æˆåŠŸå‰‡è¿”å›éŸ¿æ‡‰
                } catch (error) {
                    // å¦‚æœä¸æ˜¯æœ€å¾Œä¸€æ¬¡å˜—è©¦ï¼Œå‰‡ç­‰å¾…ä¸¦é‡è©¦
                    if (i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        // æœ€å¾Œä¸€æ¬¡å˜—è©¦å¤±æ•—ï¼Œæ‹‹å‡ºéŒ¯èª¤
                        throw error;
                    }
                }
            }
        }

        async function fetchData() {
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');

            try {
                // ä½¿ç”¨ fetchWithRetry æé«˜é€£ç·šç©©å®šæ€§ï¼Œä¸¦æ˜ç¢ºè¨­å®š mode: 'cors'
                const response = await fetchWithRetry(GAS_URL, {
                    method: 'GET', // æ˜ç¢ºæŒ‡å‡ºé€™æ˜¯ GET è«‹æ±‚
                    mode: 'cors',  // è·¨åŸŸè«‹æ±‚
                    cache: 'no-cache'
                });
                
                // æª¢æŸ¥ Content-Typeï¼Œå¦‚æœ Apps Script è¿”å›éŒ¯èª¤é é¢ (é€šå¸¸æ˜¯ HTML) è€Œä¸æ˜¯ JSONï¼Œæœƒå°è‡´ .json() å¤±æ•—ã€‚
                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    console.error("Received non-JSON response. Check Apps Script deployment settings.");
                    throw new Error("ä¼ºæœå™¨å›æ‡‰æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèª Apps Script éƒ¨ç½²è¨­å®šï¼šåŸ·è¡Œèº«ä»½ç‚ºã€Œæˆ‘ã€ï¼Œå­˜å–æ¬Šé™ç‚ºã€Œæ‰€æœ‰äººã€ã€‚");
                }


                const result = await response.json();

                if (result.success) {
                    renderDashboard(result.data);
                } else {
                    // ä½¿ç”¨ custom modal è€Œé alert
                    showMessageBox('è®€å–å¤±æ•—ï¼š' + result.message);
                }
            } catch (error) {
                console.error("Fetch Error:", error);
                // é¡¯ç¤ºæ›´è©³ç´°çš„éŒ¯èª¤è¨Šæ¯
                showMessageBox(`é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ Apps Script éƒ¨ç½²ç‹€æ…‹æˆ–ç¶²å€æ˜¯å¦æ­£ç¢ºï¼š${error.message}`);
            } finally {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
            }
        }

        function renderDashboard(data) {
            if(!data || data.length === 0) {
                document.getElementById('totalCount').innerText = "0";
                // ç¢ºä¿åœ¨ç„¡è³‡æ–™æ™‚ä¹Ÿæ¸…é™¤åœ–è¡¨
                if (titleChartInstance) titleChartInstance.destroy();
                if (unitChartInstance) unitChartInstance.destroy();
                document.getElementById('recentTableBody').innerHTML = '';
                return;
            }

            // 1. è¨ˆç®—é—œéµæŒ‡æ¨™
            const total = data.length;
            const snackYes = data.filter(d => d.snacks === 'éœ€è¦').length;
            const uniqueUnits = new Set(data.map(d => d.unit)).size;

            // æ›´æ–° DOM
            document.getElementById('totalCount').innerText = total;
            document.getElementById('snackCount').innerText = snackYes;
            document.getElementById('unitCount').innerText = uniqueUnits;
            
            // æ›´æ–°é€²åº¦æ¢
            const snackPercent = Math.round((snackYes / total) * 100);
            document.getElementById('snackProgress').style.width = `${snackPercent}%`;

            // 2. æº–å‚™åœ–è¡¨æ•¸æ“š
            // è·ç¨±çµ±è¨ˆ
            const titleCounts = {};
            data.forEach(d => { titleCounts[d.title] = (titleCounts[d.title] || 0) + 1; });

            // å–®ä½çµ±è¨ˆ (å–å‰ 5 å)
            const unitCounts = {};
            data.forEach(d => { 
                const unitName = d.unit || 'æœªå¡«å¯«'; // è™•ç†ç©ºå€¼
                unitCounts[unitName] = (unitCounts[unitName] || 0) + 1; 
            });
            const sortedUnits = Object.entries(unitCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            // 3. ç¹ªè£½è·ç¨±åœ“é¤…åœ–
            const ctxTitle = document.getElementById('titleChart').getContext('2d');
            if (titleChartInstance) titleChartInstance.destroy();
            
            titleChartInstance = new Chart(ctxTitle, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(titleCounts),
                    datasets: [{
                        data: Object.values(titleCounts),
                        backgroundColor: ['#FF6B6B', '#4ECDC4', '#FFD93D', '#1A535C', '#F7FFF7'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });

            // 4. ç¹ªè£½å–®ä½é•·æ¢åœ–
            const ctxUnit = document.getElementById('unitChart').getContext('2d');
            if (unitChartInstance) unitChartInstance.destroy();

            unitChartInstance = new Chart(ctxUnit, {
                type: 'bar',
                data: {
                    labels: sortedUnits.map(i => i[0]),
                    datasets: [{
                        label: 'å ±åäººæ•¸',
                        data: sortedUnits.map(i => i[1]),
                        backgroundColor: '#4ECDC4',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y', // è½‰ç‚ºæ©«å‘é•·æ¢åœ–
                    scales: {
                        x: { beginAtZero: true, ticks: { stepSize: 1 } }
                    }
                }
            });

            // 5. æ›´æ–°æœ€æ–°åˆ—è¡¨è¡¨æ ¼ (å–æœ€å¾Œ 5 ç­†ä¸¦åè½‰é †åº)
            const recentData = data.slice(-5).reverse();
            const tbody = document.getElementById('recentTableBody');
            tbody.innerHTML = '';

            recentData.forEach(row => {
                // æ ¼å¼åŒ–æ™‚é–“
                let timeStr = row.timestamp;
                try {
                    const date = new Date(row.timestamp);
                    // åŠ ä¸Šå¹´ä»½åˆ¤æ–·ï¼Œé¿å…è·¨å¹´å•é¡Œ
                    const now = new Date();
                    const year = date.getFullYear() === now.getFullYear() ? '' : `${date.getFullYear()}/`;
                    timeStr = `${year}${date.getMonth()+1}/${date.getDate()} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                } catch(e) {}

                const tr = `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${timeStr}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${row.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.unit}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                                ${row.title}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${row.snacks === 'éœ€è¦' ? 'ğŸª' : '-'}
                        </td>
                    </tr>
                `;
                tbody.innerHTML += tr;
            });
        }
    </script>
</body>
</html>
